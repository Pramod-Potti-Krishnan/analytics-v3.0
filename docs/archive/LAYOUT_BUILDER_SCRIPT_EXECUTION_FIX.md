# Layout Builder Script Execution Fix Request

**Date**: 2025-01-15
**Priority**: CRITICAL
**Issue**: Charts not rendering due to `<script>` tags not executing when inserted via `innerHTML`

---

## Problem Statement

ApexCharts HTML is correctly generated by Analytics Microservice with:
- ✅ Proper JavaScript function formatters (unquoted)
- ✅ Valid ApexCharts configuration
- ✅ Correct IIFE wrapping
- ✅ Reveal.js integration

**BUT**: The `<script>` tags inside `element_3` **do not execute** when inserted via `innerHTML` in the Layout Builder viewer.

---

## Root Cause

**File**: `viewer/presentation-viewer.html`
**Line**: ~Line 180 (in `renderPresentation()` function)

```javascript
// Current code (BROKEN):
const slideHTML = renderer(content);
slidesContainer.innerHTML += slideHTML;  // ❌ <script> tags don't execute!
```

**Browser Security**: When HTML containing `<script>` tags is inserted via `.innerHTML`, the browser **does not execute** those scripts for security reasons. This is standard browser behavior.

**Evidence**: Open browser console on presentation → No ApexCharts errors, no chart initialization, scripts are present in DOM but never executed.

---

## Solution Options

### Option 1: Parse and Execute Scripts (RECOMMENDED)

Modify `renderPresentation()` to extract and execute `<script>` tags after inserting HTML:

```javascript
// FIXED CODE:
function renderPresentation(data) {
  // ... existing code ...

  data.slides.forEach((slide, index) => {
    const layout = slide.layout;
    const content = slide.content;
    const renderer = RENDERERS[layout];

    if (!renderer) {
      // ... error handling ...
      return;
    }

    try {
      const slideHTML = renderer(content);

      // Create a temporary container
      const tempContainer = document.createElement('div');
      tempContainer.innerHTML = slideHTML;

      // Extract all script tags
      const scripts = tempContainer.querySelectorAll('script');

      // Insert the HTML (without scripts executing)
      slidesContainer.innerHTML += tempContainer.innerHTML;

      // Manually execute each script
      scripts.forEach(oldScript => {
        const newScript = document.createElement('script');

        // Copy attributes
        Array.from(oldScript.attributes).forEach(attr => {
          newScript.setAttribute(attr.name, attr.value);
        });

        // Copy script content
        newScript.textContent = oldScript.textContent;

        // Append to document (this executes the script)
        document.body.appendChild(newScript);
      });

    } catch (error) {
      console.error(`Error rendering slide ${index + 1}:`, error);
      // ... error handling ...
    }
  });

  // Initialize Reveal.js AFTER all scripts have executed
  setTimeout(() => {
    if (typeof initReveal === 'function') {
      initReveal();
    }
  }, 200);  // Give scripts time to execute
}
```

**Why This Works**:
- Extracts `<script>` tags from HTML
- Creates new script elements
- Appends them to document (which executes them)
- Browser executes ApexCharts initialization code

---

### Option 2: Use `appendChild` Instead of `innerHTML`

Alternative approach using DOM manipulation:

```javascript
function renderPresentation(data) {
  // ... existing code ...

  data.slides.forEach((slide, index) => {
    const layout = slide.layout;
    const content = slide.content;
    const renderer = RENDERERS[layout];

    if (!renderer) {
      // ... error handling ...
      return;
    }

    try {
      const slideHTML = renderer(content);

      // Create section element
      const section = document.createElement('section');
      section.innerHTML = slideHTML;

      // Append section to slides container
      slidesContainer.appendChild(section);

      // Find and re-execute scripts in this section
      const scripts = section.querySelectorAll('script');
      scripts.forEach(oldScript => {
        const newScript = document.createElement('script');
        Array.from(oldScript.attributes).forEach(attr => {
          newScript.setAttribute(attr.name, attr.value);
        });
        newScript.textContent = oldScript.textContent;

        // Replace old script with new one (this executes it)
        oldScript.parentNode.replaceChild(newScript, oldScript);
      });

    } catch (error) {
      console.error(`Error rendering slide ${index + 1}:`, error);
      // ... error handling ...
    }
  });

  // Initialize Reveal.js
  setTimeout(() => {
    if (typeof initReveal === 'function') {
      initReveal();
    }
  }, 200);
}
```

---

### Option 3: Use `DOMParser` (Most Robust)

Most modern and cleanest approach:

```javascript
function renderPresentation(data) {
  const slidesContainer = document.getElementById('slides-container');
  slidesContainer.innerHTML = '';

  document.title = data.title || 'Presentation';

  data.slides.forEach((slide, index) => {
    const layout = slide.layout;
    const content = slide.content;
    const renderer = RENDERERS[layout];

    if (!renderer) {
      // ... error handling ...
      return;
    }

    try {
      const slideHTML = renderer(content);

      // Parse HTML using DOMParser
      const parser = new DOMParser();
      const doc = parser.parseFromString(slideHTML, 'text/html');
      const section = doc.body.firstChild;

      // Import the section node into current document
      const importedSection = document.importNode(section, true);
      slidesContainer.appendChild(importedSection);

      // Execute scripts
      const scripts = importedSection.querySelectorAll('script');
      scripts.forEach(oldScript => {
        const newScript = document.createElement('script');

        if (oldScript.src) {
          // External script
          newScript.src = oldScript.src;
        } else {
          // Inline script
          newScript.textContent = oldScript.textContent;
        }

        // Replace old with new (executes the script)
        oldScript.parentNode.replaceChild(newScript, oldScript);
      });

    } catch (error) {
      console.error(`Error rendering slide ${index + 1}:`, error);
      // ... error handling ...
    }
  });

  // Initialize Reveal.js after all slides and scripts loaded
  setTimeout(() => {
    if (typeof initReveal === 'function') {
      initReveal();
    } else {
      Reveal.initialize({
        width: 1920,
        height: 1080,
        margin: 0,
        minScale: 0.1,
        maxScale: 3.0,
        center: true,
        controls: true,
        progress: true,
        slideNumber: 'c/t',
        hash: true,
        history: true
      });
    }
  }, 300);

  console.log(`✅ Presentation rendered: ${data.slides.length} slides`);
}
```

---

## Recommended Implementation

**Use Option 1** (Parse and Execute Scripts) because:
- ✅ Most straightforward to implement
- ✅ Works with existing renderer functions
- ✅ Handles both inline and external scripts
- ✅ Easy to test and debug
- ✅ Minimal changes to existing code

---

## Testing Instructions

### 1. Apply the Fix

Modify `viewer/presentation-viewer.html` (around line 180) to use Option 1 implementation.

### 2. Test with Existing Presentation

Open: https://web-production-f0d13.up.railway.app/p/9d72e2d1-8305-41db-ba87-bebf4d14b36e

**Expected Results**:
- ✅ Line chart renders with smooth curve
- ✅ Bar chart renders with vertical bars
- ✅ Donut chart renders with three segments
- ✅ Tooltips work on hover
- ✅ Charts animate on slide change
- ✅ No console errors

### 3. Verify Script Execution

Open browser console and check:
```javascript
// Should see ApexCharts initialized
console.log('Charts initialized:', document.querySelectorAll('.apexcharts-canvas').length);
// Should return 3 (one for each chart slide)
```

### 4. Check DOM

Inspect `.diagram-container`:
- Should contain `<div id="chart-xxx">` with ApexCharts SVG inside
- SVG should have `.apexcharts-canvas` class
- Chart should be visible (not clipped by overflow)

---

## Impact Assessment

### Current State (BROKEN):
- ❌ Charts don't render at all
- ❌ `<script>` tags present in DOM but never execute
- ❌ ApexCharts never initializes
- ❌ No errors in console (silent failure)

### After Fix:
- ✅ Charts render correctly
- ✅ Scripts execute when slides are created
- ✅ ApexCharts initializes properly
- ✅ Interactive features work (hover, tooltips, animations)
- ✅ Reveal.js integration works seamlessly

---

## File to Modify

**Single File**: `viewer/presentation-viewer.html`

**Function to Update**: `renderPresentation()` (around line 155-220)

**Lines to Change**: ~10-15 lines inside the slide rendering loop

---

## Additional Notes

### Why `.innerHTML` Doesn't Execute Scripts

From MDN Web Docs:
> "Although this may look like a cross-site scripting attack, the result is harmless. HTML specifies that a `<script>` tag inserted with innerHTML should not execute."

Reference: https://developer.mozilla.org/en-US/docs/Web/API/Element/innerHTML#security_considerations

### ApexCharts CDN Loading

The current implementation loads ApexCharts CDN **per slide** (embedded in each chart HTML). This is inefficient but works. Consider:
- Loading ApexCharts once in `<head>` of viewer
- Removing `<script src="...apexcharts...">` from Analytics-generated HTML

But this can be a **future optimization** - not required for the immediate fix.

---

## Timeline

**Critical Priority**: This blocks all chart rendering functionality

**Requested Turnaround**: 24 hours

**Testing Support**: Analytics team available for immediate testing once deployed

---

## Summary

| Component | Current Status | After Fix |
|-----------|---------------|-----------|
| Script Execution | ❌ Scripts don't run | ✅ Scripts execute correctly |
| Chart Rendering | ❌ No charts visible | ✅ All charts render |
| Interactive Features | ❌ Not working | ✅ Hover, tooltips work |
| Console Errors | ❌ Silent failure | ✅ Proper error handling |

**Action Required**: Modify `viewer/presentation-viewer.html` to execute `<script>` tags using Option 1 approach.
