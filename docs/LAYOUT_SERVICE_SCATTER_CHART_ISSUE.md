# Layout Service - Scatter Chart Rendering Issue

**Date**: November 18, 2025
**Severity**: üî¥ HIGH (Scatter charts completely blank)
**Affected Charts**: Scatter plots only (bubbles work fine)
**Analytics Service Version**: v3.2.0 (deployed to Railway)

---

## Issue Summary

Scatter charts generated by Analytics Service v3.2.0 appear **completely blank** when rendered in the Layout Service, while bubble charts and all other chart types (bar, pie, line, doughnut, radar) render correctly.

**Symptoms**:
- Scatter chart canvas exists but shows no data points
- Chart axes visible but empty
- No JavaScript console errors (Chart.js library IS loaded)
- Bubble charts on the same page work perfectly

---

## Technical Analysis

### What Analytics Service Sends (CORRECT):

**Scatter Chart Response** (POST `/api/v1/analytics/L02/correlation_analysis`):
```json
{
  "content": {
    "element_3": "<div>...<canvas id='chart-scatter-xxx'>...</canvas>...</div>"
  },
  "metadata": {
    "chart_type": "scatter",
    "chart_data": {
      "type": "scatter",
      "data": {
        "datasets": [{
          "data": [
            {"x": 0, "y": 100.0, "label": "Point 1"},
            {"x": 1, "y": 200.0, "label": "Point 2"}
          ],
          "pointStyle": "cross",     // ‚úÖ v3.2.0: X marks
          "pointRadius": 10,          // ‚úÖ 10px size
          "backgroundColor": "#FF6B6B",
          "borderColor": "#FF6B6B"
        }]
      }
    }
  }
}
```

**Key Properties**:
- ‚úÖ Chart type: `"scatter"` (correct)
- ‚úÖ Data format: `{x, y, label}` object points (correct for scatter)
- ‚úÖ Point style: `"cross"` (X marks as requested)
- ‚úÖ Point radius: `10` (visible size)
- ‚úÖ Canvas element present
- ‚úÖ Initialization script present
- ‚úÖ Reveal.js detection + fallback present

### Comparison: Bubble Chart (WORKS):

**Bubble Chart Response** (POST `/api/v1/analytics/L02/multidimensional_analysis`):
```json
{
  "chart_data": {
    "type": "bubble",
    "data": {
      "datasets": [{
        "data": [
          {"x": 0, "y": 100.0, "r": 8, "label": "Point 1"},
          {"x": 1, "y": 200.0, "r": 40, "label": "Point 2"}
        ],
        "pointStyle": "circle",    // Circle points
        "backgroundColor": "#FF6B6B"
      }]
    }
  }
}
```

**Bubbles work perfectly** - so Chart.js library IS loaded and functioning.

---

## Possible Root Causes

### Hypothesis 1: `pointStyle: "cross"` Not Supported
**Likelihood**: üü° MEDIUM

Chart.js supports these point styles:
- 'circle', 'cross', 'crossRot', 'dash', 'line', 'rect', 'rectRounded', 'rectRot', 'star', 'triangle'

**Test**: Can you verify if changing `pointStyle` from `"cross"` to `"circle"` makes scatter charts appear?

**Workaround**: If cross marks don't work, we can use 'crossRot' or 'rectRot' as alternatives.

---

### Hypothesis 2: Scatter Chart Initialization Timing Issue
**Likelihood**: üü¢ LOW (but possible)

The scatter chart initialization code waits for Reveal.js OR DOM ready:

```javascript
if (typeof Reveal !== 'undefined') {
  Reveal.on('ready', function() {
    initChart();  // Wait for Reveal.js
  });
} else {
  // Fallback: init immediately
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initChart);
  } else {
    initChart();
  }
}
```

**Potential Issue**: If the scatter chart HTML is inserted **after** `DOMContentLoaded` fires but **before** Reveal.js is ready, the chart might never initialize.

**Test**: Check browser console for:
- `‚úÖ Chart chart-xxx initialized successfully` (should appear for scatter)
- Any warnings like `Chart init on ready failed`

---

### Hypothesis 3: CSS/Layout Conflict Specific to Scatter
**Likelihood**: üî¥ HIGH

**Possible Issue**: The layout service might have CSS rules or viewport settings that conflict with scatter chart rendering but not bubble charts.

**Things to Check**:
1. **Canvas dimensions**: Are scatter chart canvases getting `width: 0` or `height: 0`?
2. **Z-index stacking**: Is something covering the scatter chart?
3. **Clip paths**: Is the scatter chart being clipped outside the visible area?

**Browser DevTools Check**:
```
1. Inspect the blank scatter chart canvas element
2. Check computed styles for:
   - width, height (should be > 0)
   - display (should be 'block' or 'inline-block')
   - visibility (should be 'visible')
   - opacity (should be 1)
   - z-index (should allow visibility)
3. Check parent container styles
```

---

### Hypothesis 4: Chart.js Version Incompatibility
**Likelihood**: üü° MEDIUM

**Question**: What version of Chart.js is the Layout Service using?

**Analytics Service expects**:
- Chart.js v4.4.0 or higher
- chartjs-plugin-datalabels v2.2.0

**Compatibility Check**:
```javascript
// In browser console on the page with charts
console.log(Chart.version);  // Should be "4.4.0" or higher
console.log(ChartDataLabels.id);  // Should exist
```

If you're using Chart.js v3.x or earlier, scatter charts with `pointStyle: "cross"` might not work correctly.

---

## Debugging Steps for Layout Service Team

### Step 1: Browser Console Check
When viewing a blank scatter chart:

```javascript
// 1. Check if Chart.js is loaded
console.log(typeof Chart);  // Should be "function"
console.log(Chart.version);  // Should be "4.4.0" or higher

// 2. Check if scatter chart initialized
console.log(window.chartInstances);  // Should show scatter chart ID

// 3. Get scatter chart instance
const scatterChart = window.chartInstances['chart-scatter-xxx'];
console.log(scatterChart);  // Should be a Chart object

// 4. Check chart data
console.log(scatterChart.data);  // Should show datasets with points

// 5. Check canvas dimensions
const canvas = document.getElementById('chart-scatter-xxx');
console.log(canvas.width, canvas.height);  // Should be > 0
console.log(getComputedStyle(canvas).display);  // Should not be 'none'
```

### Step 2: Inspect Chart Canvas
```javascript
// Get the scatter chart canvas
const canvas = document.getElementById('chart-scatter-xxx');

// Check dimensions
console.log('Canvas dimensions:', {
  clientWidth: canvas.clientWidth,
  clientHeight: canvas.clientHeight,
  offsetWidth: canvas.offsetWidth,
  offsetHeight: canvas.offsetHeight,
  scrollWidth: canvas.scrollWidth,
  scrollHeight: canvas.scrollHeight
});

// Check if it's visible
const rect = canvas.getBoundingClientRect();
console.log('Canvas position:', rect);
console.log('Is in viewport?', rect.width > 0 && rect.height > 0);
```

### Step 3: Force Re-render
```javascript
// Get chart instance
const chart = window.chartInstances['chart-scatter-xxx'];

// Force update
chart.update('active');

// Check if points are being drawn
console.log('Chart elements:', chart.getDatasetMeta(0).data);
```

---

## Required Information from Layout Service

Please provide:

1. **Chart.js Version**:
   ```javascript
   console.log(Chart.version);
   ```

2. **Browser Console Output** when viewing blank scatter chart:
   - Any errors or warnings
   - Result of `window.chartInstances`
   - Result of scatter chart inspection (Step 1 above)

3. **Canvas Dimensions**:
   - Screenshot of DevTools showing the `<canvas>` element's computed styles
   - Width and height values

4. **Working Bubble Chart Comparison**:
   - Inspect a working bubble chart on the same page
   - Compare canvas styles between bubble (working) and scatter (broken)

5. **Layout Service Integration Method**:
   - How is the chart HTML inserted? (`innerHTML`, `dangerouslySetInnerHTML`, iframe?)
   - Is there any post-processing of the HTML before insertion?
   - Are there any Content Security Policy restrictions?

---

## Temporary Workaround

If you need scatter charts working immediately, I can provide a hotfix that:

**Option A**: Change `pointStyle` from `"cross"` to `"circle"` (removes X marks, uses circles)
**Option B**: Increase `pointRadius` from 10 to 20 (in case points are too small to see)
**Option C**: Add explicit color enforcement (in case color inheritance is failing)

Let me know which workaround you'd prefer while we debug the root cause.

---

## Contact

**Analytics Service Team**: Available for pair debugging session
**Railway Logs**: https://analytics-v30-production.up.railway.app (check for errors)
**Test Endpoint**: POST `/api/v1/analytics/L02/correlation_analysis`

---

## Appendix: Sample Test Data

To reproduce the issue, call Analytics Service with:

```bash
curl -X POST https://analytics-v30-production.up.railway.app/api/v1/analytics/L02/correlation_analysis \
  -H "Content-Type: application/json" \
  -d '{
    "presentation_id": "test-scatter",
    "slide_id": "scatter-debug",
    "slide_number": 1,
    "narrative": "Testing scatter chart visibility",
    "data": [
      {"label": "Point 1", "value": 100},
      {"label": "Point 2", "value": 150},
      {"label": "Point 3", "value": 200}
    ]
  }'
```

Expected response includes working scatter chart HTML with X marks at coordinates (0,100), (1,150), (2,200).

---

**Status**: ‚è≥ AWAITING LAYOUT SERVICE TEAM INVESTIGATION
**Next Steps**: Layout Service team to provide debugging information listed above
